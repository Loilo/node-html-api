function isCustomTypeConstraint(e){return isPlainObject(e)&&"function"==typeof e.validate&&"function"==typeof e.serialize&&"function"==typeof e.unserialize}function isValidSingleTypeConstraint(e){return has(toArray(presetTypes.keys()),e)||isCustomTypeConstraint(e)}function isValidTypeConstraint(e){return Array.isArray(e)?e.length&&e.every(isValidSingleTypeConstraint)&&e.some(function(e){return null!==e}):isValidSingleTypeConstraint(e)&&null!==e}function createMultiConstraintDetector(e){Array.isArray(e)||(e=[e]);var t=toArray(presetTypes.keys());return e=e.slice(0).sort(function(e,n){var r=t.indexOf(e),i=t.indexOf(n);return r===i?0:-1===r?-1:-1===i?1:r<i?-1:1}).map(function(e){return presetTypes.has(e)?presetTypes.get(e):e}),function(t,n){return find(e,function(e){try{var r=t;return n&&(r=e.unserialize(t)),e.validate(r)}catch(e){return!1}})}}function validateOptionDefinition(e){if(isValidTypeConstraint(e))return!0;if(!isPlainObject(e))throw new Error("Definition must be a type constraint or an object.");if(!isValidTypeConstraint(e.type))throw Error("Definition must have a valid type constraint");var t=createMultiConstraintDetector(e.type);if(e.required&&!isUndef(e.default))throw new Error("Option can either be required or have a default value, not both");if(e.required||!isUndef(e.default)||null===e.type||Array.isArray(e.type)&&has(e.type,null)||(Array.isArray(e.type)?e.type.push(null):e.type=[e.type,null]),!isUndef(e.default)&&!t(e.default))throw new Error("Default value is invalid")}function validateOptionsDefinition(e){if(!isPlainObject(e))throw new Error("Options definition must be a plain object");for(var t=0,n=entries(e);t<n.length;t+=1){var r=n[t],i=r[0],a=r[1];try{validateOptionDefinition(a),isValidTypeConstraint(a)&&(Array.isArray(a)?has(a,null)||a.push(null):null!==a&&(e[i]=[a,null]))}catch(e){throw new Error('Option definition for option "'+i+'" failed: '+e.message)}}}function getTypeConstraints(e){return isValidTypeConstraint(e)?Array.isArray(e)?e:isCustomTypeConstraint(e)?[e]:[presetTypes.get(e)]:Array.isArray(e.type)?e.type:isCustomTypeConstraint(e.type)?[e.type]:[presetTypes.get(e.type)]}function validateOptionValue(e,t,n){void 0===n&&(n=!1);var r=getTypeConstraints(t);if(!0===t.required&&void 0===e)throw new Error("Invalid option removal");if(null==e&&has(r,null))return n?null:"null";var i,a=createMultiConstraintDetector(r);if(n){var o=a(e,!0);try{i=o.unserialize(e)}catch(t){throw new Error('Invalid serialized option value "'+e+'"')}if(!o.validate(i))throw new Error('Invalid serialized option value "'+e+'"')}else{var u=a(e,!1);if(isUndef(u)||!u.validate(e))throw new Error('Invalid option value "'+e+'"');i=u.serialize(e)}return i}function publishChange(e,t,n,r,i){void 0===i&&(i=!1),e.emit("change",{option:t,value:n,oldValue:r,initial:i}),e.emit("change:"+t,{value:n,oldValue:r,initial:i})}function getInitialValues(e,t,n){for(var r=Object.create(null),i={},a=0,o=entries(t);a<o.length;a+=1)!function(){var t=o[a],u=t[0],s=t[1],l=e.dataset[u];if(null!=l)try{r[u]=validateOptionValue(l,s,!0)}catch(e){throw new Error('Error setting initial option "'+u+'": '+e.message)}else s&&s.required?requestAnimationFrame(function(){n.emit("error",{type:"missing-required",message:'Missing required option "'+u+'"',details:u})}):s&&void 0!==s.default?r[u]=s.default:r[u]=null;i[u]=setTimeout(function(){publishChange(n,u,r[u],null,!0),delete i[u]},0)}();return{values:r,bufferedInitials:i}}function createOptionsAttrList(e){return Object.keys(e).map(function(e){return"data-"+kebab(e)})}function createOptionsInterface(e,t,n,r){for(var i=Object.create(null),a=0,o=entries(t);a<o.length;a+=1)!function(){var t=o[a],u=t[0],s=t[1];Object.defineProperty(i,u,{get:function(){return n[u]},set:function(t){try{var i=validateOptionValue(t,s,!1);"string"==typeof i?(e.dataset[u]=i,n[u]=t):(delete e.dataset[u],delete n[u])}catch(e){r.emit("error",{type:"invalid-value-js",details:{option:u,value:t},message:'Error setting option "'+u+'": '+e.message})}}})}();return i}function observeAttributes(e,t,n){var r=new MutationObserver(function(e){for(var t=0,r=e;t<r.length;t+=1){var i=r[t];"attributes"===i.type&&n(i.attributeName.slice(5),i.oldValue)}});return r.observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:t}),r}function createMutationHandler(e,t,n,r){return function(i,a){var o=camel(i),u=t[o],s=e.dataset[o];if(s!==a)try{var l=validateOptionValue(s,u,!0),f=validateOptionValue(a,u,!0);n[o]=l,publishChange(r,o,l,f)}catch(e){r.emit("error",{type:"invalid-value-html",details:{option:o,value:s},message:'Error setting option "'+o+'" via HTML: '+e.message})}}}function createAttributeObserver(e,t,n,r){return observeAttributes(e,createOptionsAttrList(t),createMutationHandler(e,t,n,r))}function validateElementConstraint(e){var t=null;if("string"==typeof e?t=e:e instanceof Element?t=[e]:((e instanceof NodeList||e instanceof HTMLCollection)&&(e=toArray(e)),Array.isArray(e)&&(t=e.every(function(e){return e instanceof Element})?e:null)),t)return t;throw new Error("Provided elements must either be a selector string, an Element, an array of Elements or a NodeList containing exclusively Element nodes")}function createElementBasedApi(e,t,n){var r=mitt();r.on("*",function(t,r){n.emit(t,extend({element:e,elementApi:l},r))});var i=getInitialValues(e,t,r),a=i.values,o=i.bufferedInitials;for(var u in o)!function(e){r.once("change:"+e,function(){clearTimeout(o[e]),delete o[e]})}(u);var s=createAttributeObserver(e,t,a,r),l={options:createOptionsInterface(e,t,a,r),on:function(e,t){return r.on(e,t),this},once:function(e,t){return r.once(e,t),this},off:function(e,t){return r.off(e,t),this},destroy:function(){s.disconnect(),r.clear()}};return l}import Map from"./polyfills/map";import mitt from"./lib/mitt";import{isUndef,kebab,camel,has,find,toArray,isPlainObject,entries,extend,matches}from"./lib/helpers";import presetTypes from"./lib/preset-types";export default function htmlApi(e){return validateOptionsDefinition(e),function(t){var n=validateElementConstraint(t),r="string"==typeof n&&n;r&&(n=toArray(document.querySelectorAll(n)));var i,a=new Map,o=mitt();r&&(i=new MutationObserver(function(t){for(var n=0,i=t;n<i.length;n+=1){var u=i[n];if("childList"===u.type){for(var s=0,l=toArray(u.addedNodes).filter(function(e){return e instanceof Element&&matches(e,r)&&!a.has(e)});s<l.length;s+=1){var f=l[s],c=createElementBasedApi(f,e,o);a.set(f,c),o.emit("newElement",{element:f,elementApi:c})}for(var d=0,p=toArray(u.removedNodes);d<p.length;d+=1){var m=p[d];m instanceof Element&&(a.has(m)&&(a.get(m).destroy(),a.delete(m)))}}}})).observe(document.documentElement,{childList:!0,subtree:!0});for(var u=0,s=n;u<s.length;u+=1)!function(){var t=s[u],n=createElementBasedApi(t,e,o);a.set(t,n),setTimeout(function(){o.emit("newElement",{element:t,elementApi:n})},0)}();return{get elements(){return toArray(a.keys())},for:function(e){var t;if(e instanceof Element)t=e;else{if("string"!=typeof e)throw new Error("Constraint must either be an Element or a selector string");t=document.querySelector(t)}if(!t)throw new Error("No element found for the given selector");if(!a.has(t))throw new Error("The given element does not have your API attached");return a.get(t)},on:function(e,t){return o.on(e,t),this},once:function(e,t){return o.once(e,t),this},off:function(e,t){return o.off(e,t),this},destroy:function(){i&&i.disconnect(),o.clear();for(var e=0,t=toArray(a.values());e<t.length;e+=1)t[e].destroy()}}}};htmlApi.Enum=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return{validate:function(t){return"string"==typeof t&&has(e,t)},serialize:function(e){return e},unserialize:function(e){return e}}};var numGen=function(e,t,n){return void 0===e&&(e=-1/0),void 0===t&&(t=1/0),void 0===n&&(n=!0),{validate:function(r){if("number"!=typeof r||!isFinite(r))return!1;if(!n)if(Number.isInteger){if(!Number.isInteger(r))return!1}else if(Math.floor(r)!==r)return!1;return r>=e&&r<=t},serialize:function(e){return String(e)},unserialize:function(e){return+e}}};htmlApi.Integer=extend(numGen(-1/0,1/0,!1),{min:function(e){return extend(numGen(e,1/0,!1),{max:function(t){return numGen(e,t,!1)}})},max:function(e){return numGen(-1/0,e,!1)}}),htmlApi.Float=extend(numGen(-1/0,1/0),{min:function(e){return extend(numGen(e,1/0),{max:function(t){return numGen(e,t)}})},max:function(e){return numGen(-1/0,e)}});
