function mitt(e,t){return e=e||Object.create(null),t=t||Object.create(null),{on:function(t,n,r){if(void 0===r&&(r=0),0===r)(e[t]||(e[t]=[])).push(n);else{var i=this;this.once(t,function(){i.on(t,n)},r-1)}},once:function(e,n,r){if(void 0===r&&(r=0),0===r)(t[e]||(t[e]=[])).push(n);else{var i=this;(t[e]||(t[e]=[])).push(function(){i.once(e,n,r-1)})}},off:function(n,r){e[n]&&e[n].splice(e[n].indexOf(r)>>>0,1),t[n]&&t[n].splice(t[n].indexOf(r)>>>0,1)},emit:function(n,r){(e[n]||[]).map(function(e){e(r)}),(e["*"]||[]).map(function(e){e(n,r)}),(t[n]||[]).map(function(e){e(r)}),(t["*"]||[]).map(function(e){e(n,r)})},clear:function(){e={},t={}},get _listeners(){return e}}}function entries(e){return Object.keys(e).map(function(t){return[t,e[t]]})}function has(e,t){return e.includes?e.includes(t):-1!==e.indexOf(t)}function find(e,t){if(e.find)return e.find(t);for(var n=0;n<e.length;n++)if(t(e[n],n,e))return e[n]}function toArray(e){if(Array.from)return Array.from(e);if(Array.isArray(e))return e.slice(0);for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t}function extend(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];if(Object.assign)return Object.assign.apply(Object,e);if(0===e.length)throw new TypeError("Cannot convert undefined or null to object");if(1===e.length)return e[0];for(var n in e[1])e[0][n]=e[1][n];return extend.apply(void 0,[e[0]].concat(e.slice(2)))}function isPlainObject(e){return"object"==typeof e&&null!==e&&null==e.prototype}function isCustomTypeConstraint(e){return isPlainObject(e)&&"function"==typeof e.validate&&"function"==typeof e.serialize&&"function"==typeof e.unserialize}function isValidSingleTypeConstraint(e){return has(toArray(presetTypes.keys()),e)||isCustomTypeConstraint(e)}function isValidTypeConstraint(e){return Array.isArray(e)?e.length&&e.every(isValidSingleTypeConstraint)&&e.some(function(e){return null!==e}):isValidSingleTypeConstraint(e)&&null!==e}function createMultiConstraintDetector(e){Array.isArray(e)||(e=[e]);var t=toArray(presetTypes.keys());return e=e.slice(0).sort(function(e,n){var r=t.indexOf(e),i=t.indexOf(n);return r===i?0:-1===r?-1:-1===i?1:r<i?-1:1}).map(function(e){return presetTypes.has(e)?presetTypes.get(e):e}),function(t,n){return find(e,function(e){try{var r=t;return n&&(r=e.unserialize(t)),e.validate(r)}catch(e){return!1}})}}function isUndef(e){return void 0===e}function matches(e,t){var n=Element.prototype;return(n.matches||n.webkitMatchesSelector||n.mozMatchesSelector||n.msMatchesSelector||function(e){return-1!==[].indexOf.call(document.querySelectorAll(e),this)}).call(e,t)}function validateOptionDefinition(e){if(isValidTypeConstraint(e))return!0;if(!isPlainObject(e))throw new Error("Definition must be a type constraint or an object.");if(!isValidTypeConstraint(e.type))throw Error("Definition must have a valid type constraint");var t=createMultiConstraintDetector(e.type);if(e.required&&!isUndef(e.default))throw new Error("Option can either be required or have a default value, not both");if(e.required||!isUndef(e.default)||null===e.type||Array.isArray(e.type)&&has(e.type,null)||(Array.isArray(e.type)?e.type.push(null):e.type=[e.type,null]),!isUndef(e.default)&&!t(e.default))throw new Error("Default value is invalid")}function validateOptionsDefinition(e){if(!isPlainObject(e))throw new Error("Options definition must be a plain object");for(var t=0,n=entries(e);t<n.length;t+=1){var r=n[t],i=r[0],o=r[1];try{validateOptionDefinition(o),isValidTypeConstraint(o)&&(Array.isArray(o)?has(o,null)||o.push(null):null!==o&&(e[i]=[o,null]))}catch(e){throw new Error('Option definition for option "'+i+'" failed: '+e.message)}}}function getTypeConstraints(e){return isValidTypeConstraint(e)?Array.isArray(e)?e:isCustomTypeConstraint(e)?[e]:[presetTypes.get(e)]:Array.isArray(e.type)?e.type:isCustomTypeConstraint(e.type)?[e.type]:[presetTypes.get(e.type)]}function validateOptionValue(e,t,n){void 0===n&&(n=!1);var r=getTypeConstraints(t);if(!0===t.required&&void 0===e)throw new Error("Invalid option removal");if(null==e&&has(r,null))return n?null:"null";var i,o=createMultiConstraintDetector(r);if(n){var a=o(e,!0);try{i=a.unserialize(e)}catch(t){throw new Error('Invalid serialized option value "'+e+'"')}if(!a.validate(i))throw new Error('Invalid serialized option value "'+e+'"')}else{var u=o(e,!1);if(isUndef(u)||!u.validate(e))throw new Error('Invalid option value "'+e+'"');i=u.serialize(e)}return i}function publishChange(e,t,n,r,i){void 0===i&&(i=!1),e.emit("change",{option:t,value:n,oldValue:r,initial:i}),e.emit("change:"+t,{value:n,oldValue:r,initial:i})}function getInitialValues(e,t,n){for(var r=Object.create(null),i={},o=0,a=entries(t);o<a.length;o+=1)!function(){var t=a[o],u=t[0],l=t[1],s=e.dataset[u];if(null!=s)try{r[u]=validateOptionValue(s,l,!0)}catch(e){throw new Error('Error setting initial option "'+u+'": '+e.message)}else l&&l.required?requestAnimationFrame(function(){n.emit("error",{type:"missing-required",message:'Missing required option "'+u+'"',details:u})}):l&&void 0!==l.default?r[u]=l.default:r[u]=null;i[u]=setTimeout(function(){publishChange(n,u,r[u],null,!0),delete i[u]},0)}();return{values:r,bufferedInitials:i}}function kebab(e){return e.replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()})}function camel(e){return e.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()})}function createOptionsAttrList(e){return Object.keys(e).map(function(e){return"data-"+kebab(e)})}function createOptionsInterface(e,t,n,r){for(var i=Object.create(null),o=0,a=entries(t);o<a.length;o+=1)!function(){var t=a[o],u=t[0],l=t[1];Object.defineProperty(i,u,{get:function(){return n[u]},set:function(t){try{var i=validateOptionValue(t,l,!1);"string"==typeof i?(e.dataset[u]=i,n[u]=t):(delete e.dataset[u],delete n[u])}catch(e){r.emit("error",{type:"invalid-value-js",details:{option:u,value:t},message:'Error setting option "'+u+'": '+e.message})}}})}();return i}function observeAttributes(e,t,n){var r=new MutationObserver(function(e){for(var t=0,r=e;t<r.length;t+=1){var i=r[t];"attributes"===i.type&&n(i.attributeName.slice(5),i.oldValue)}});return r.observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:t}),r}function createMutationHandler(e,t,n,r){return function(i,o){var a=camel(i),u=t[a],l=e.dataset[a];if(l!==o)try{var s=validateOptionValue(l,u,!0),f=validateOptionValue(o,u,!0);n[a]=s,publishChange(r,a,s,f)}catch(e){r.emit("error",{type:"invalid-value-html",details:{option:a,value:l},message:'Error setting option "'+a+'" via HTML: '+e.message})}}}function createAttributeObserver(e,t,n,r){return observeAttributes(e,createOptionsAttrList(t),createMutationHandler(e,t,n,r))}function validateElementConstraint(e){var t=null;if("string"==typeof e?t=e:e instanceof Element?t=[e]:((e instanceof NodeList||e instanceof HTMLCollection)&&(e=toArray(e)),Array.isArray(e)&&(t=e.every(function(e){return e instanceof Element})?e:null)),t)return t;throw new Error("Provided elements must either be a selector string, an Element, an array of Elements or a NodeList containing exclusively Element nodes")}function createElementBasedApi(e,t,n){var r=mitt();r.on("*",function(t,r){n.emit(t,extend({element:e,elementApi:s},r))});var i=getInitialValues(e,t,r),o=i.values,a=i.bufferedInitials;for(var u in a)!function(e){r.once("change:"+e,function(){clearTimeout(a[e]),delete a[e]})}(u);var l=createAttributeObserver(e,t,o,r),s={options:createOptionsInterface(e,t,o,r),on:function(e,t,n){return r.on(e,t,n),this},once:function(e,t,n){return r.once(e,t,n),this},off:function(e,t){return r.off(e,t),this},destroy:function(){l.disconnect(),r.clear()}};return s}var presetTypes=new Map([[null,{validate:function(e){return null==e},serialize:function(e){return"null"},unserialize:function(e){return JSON.parse(e)}}],[Boolean,{validate:function(e){return"boolean"==typeof e},serialize:function(e){return e?"":void 0},unserialize:function(e){if(void 0===e||"false"===e)return!1;if(""===e||"true"===e)return!0;throw new Error("Invalidly serialized Boolean")}}],[Number,{validate:function(e){return"number"==typeof e&&!isNaN(e)},serialize:function(e){return String(e)},unserialize:function(e){return+e}}],[Array,{validate:function(e){return Array.isArray(e)},serialize:function(e){return JSON.stringify(e)},unserialize:function(e){return JSON.parse(e)}}],[Object,{validate:function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},serialize:function(e){return JSON.stringify(e)},unserialize:function(e){return JSON.parse(e)}}],[Function,{validate:function(e){return"function"==typeof e},serialize:function(e){return String(e)},unserialize:function(value){return eval("("+value+")")}}],[String,{validate:function(e){return"string"==typeof e},serialize:function(e){return e},unserialize:function(e){return e}}]]);export default function htmlApi(e){return validateOptionsDefinition(e),function(t){var n=validateElementConstraint(t),r="string"==typeof n&&n;r&&(n=toArray(document.querySelectorAll(n)));var i,o=new Map,a=mitt();r&&(i=new MutationObserver(function(t){for(var n=0,i=t;n<i.length;n+=1){var u=i[n];if("childList"===u.type){for(var l=0,s=toArray(u.addedNodes).filter(function(e){return e instanceof Element&&matches(e,r)&&!o.has(e)});l<s.length;l+=1){var f=s[l],c=createElementBasedApi(f,e,a);o.set(f,c),a.emit("newElement",{element:f,elementApi:c})}for(var d=0,p=toArray(u.removedNodes);d<p.length;d+=1){var v=p[d];v instanceof Element&&(o.has(v)&&(o.get(v).destroy(),o.delete(v)))}}}})).observe(document.documentElement,{childList:!0,subtree:!0});for(var u=0,l=n;u<l.length;u+=1)!function(){var t=l[u],n=createElementBasedApi(t,e,a);o.set(t,n),setTimeout(function(){a.emit("newElement",{element:t,elementApi:n})},0)}();return{get elements(){return toArray(o.keys())},for:function(e){var t;if(e instanceof Element)t=e;else{if("string"!=typeof e)throw new Error("Constraint must either be an Element or a selector string");t=document.querySelector(t)}if(!t)throw new Error("No element found for the given selector");if(!o.has(t))throw new Error("The given element does not have your API attached");return o.get(t)},on:function(e,t,n){return a.on(e,t,n),this},once:function(e,t,n){return a.once(e,t,n),this},off:function(e,t){return a.off(e,t),this},destroy:function(){i&&i.disconnect(),a.clear();for(var e=0,t=toArray(o.values());e<t.length;e+=1)t[e].destroy()}}}};htmlApi.Enum=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return{validate:function(t){return"string"==typeof t&&has(e,t)},serialize:function(e){return e},unserialize:function(e){return e}}};var numGen=function(e,t,n){return void 0===e&&(e=-1/0),void 0===t&&(t=1/0),void 0===n&&(n=!0),{validate:function(r){if("number"!=typeof r||!isFinite(r))return!1;if(!n)if(Number.isInteger){if(!Number.isInteger(r))return!1}else if(Math.floor(r)!==r)return!1;return r>=e&&r<=t},serialize:function(e){return String(e)},unserialize:function(e){return+e}}};htmlApi.Integer=extend(numGen(-1/0,1/0,!1),{min:function(e){return extend(numGen(e,1/0,!1),{max:function(t){return numGen(e,t,!1)}})},max:function(e){return numGen(-1/0,e,!1)}}),htmlApi.Float=extend(numGen(-1/0,1/0),{min:function(e){return extend(numGen(e,1/0),{max:function(t){return numGen(e,t)}})},max:function(e){return numGen(-1/0,e)}});
